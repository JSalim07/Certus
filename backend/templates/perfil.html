{% extends "base.html" %}
{% block title %}Mi Perfil{% endblock %}

{% block content %}

<h1 class="text-4xl font-bold neon mb-8">Mi Perfil</h1>



<!-- SecciÃ³n: Datos actuales (oculta por defecto) -->
<div id="datos-actuales" class="card p-8 rounded-xl max-w-2xl mx-auto mb-8 hidden">
  <h2 class="text-2xl font-bold mb-4 text-cyan-300">ğŸ“‹ Tus Datos Actuales</h2>
  
  <div class="space-y-4 bg-black/40 p-6 rounded-lg">
    <div>
      <p class="text-gray-400 text-sm">ID de Usuario</p>
      <p id="mostrar-id" class="text-xl font-bold text-white"></p>
    </div>
    <div>
      <p class="text-gray-400 text-sm">Nombre</p>
      <p id="mostrar-nombre" class="text-xl font-bold text-cyan-300"></p>
    </div>
    <div>
      <p class="text-gray-400 text-sm">Correo ElectrÃ³nico</p>
      <p id="mostrar-correo" class="text-xl font-bold text-cyan-300"></p>
    </div>
  </div>
</div>

<!-- SecciÃ³n: Editar informaciÃ³n (oculta por defecto) -->
<div id="formulario-edicion" class="card p-8 rounded-xl max-w-2xl mx-auto hidden">
  <h2 class="text-2xl font-bold mb-4 text-cyan-300">âœï¸ Editar InformaciÃ³n</h2>

  <form id="perfil-form" class="space-y-5">
    <input id="usuario-id" type="hidden">

    <div>
      <label class="block mb-1">Nombre</label>
      <input id="nombre" type="text" 
             class="w-full p-2 rounded bg-black/40 border border-white/10"
             placeholder="Tu nuevo nombre..." required>
    </div>

    <div>
      <label class="block mb-1">Correo</label>
      <input id="correo" type="email" 
             class="w-full p-2 rounded bg-black/40 border border-white/10"
             placeholder="correo@example.com" required>
    </div>

    <button type="submit" class="btn-space w-full py-2 rounded-lg">
      ğŸ’¾ Guardar Cambios
    </button>
  </form>
</div>

<!-- SecciÃ³n: EstadÃ­sticas del usuario -->
<div id="estadisticas" class="card p-8 rounded-xl max-w-2xl mx-auto mt-8 hidden">
  <h2 class="text-2xl font-bold mb-4 text-cyan-300">ğŸ“Š Mis EstadÃ­sticas</h2>
  
  <div class="grid grid-cols-2 gap-4">
    <div class="bg-black/40 p-4 rounded-lg text-center">
      <p class="text-gray-400 text-sm">Total de Pujas</p>
      <p id="total-pujas" class="text-3xl font-bold text-cyan-300">0</p>
    </div>
    <div class="bg-black/40 p-4 rounded-lg text-center">
      <p class="text-gray-400 text-sm">Subastas Participando</p>
      <p id="total-subastas" class="text-3xl font-bold text-cyan-300">0</p>
    </div>
  </div>
</div>

<script>
let usuarioActual = null;

/* Obtener usuario actual automÃ¡ticamente */
async function obtenerUsuarioActual() {
  const res = await fetch('/api/usuario/actual');
  const data = await res.json();
  
  if (data.error) {
    window.location.href = '/login';
    return;
  }
  
  usuarioActual = data;
  cargarPerfil();
}

/* Cargar perfil del usuario */
async function cargarPerfil() {
  if (!usuarioActual) return;

  /* Mostrar datos actuales */
  document.getElementById('mostrar-id').textContent = usuarioActual.id;
  document.getElementById('mostrar-nombre').textContent = usuarioActual.nombre;
  document.getElementById('mostrar-correo').textContent = usuarioActual.correo;
  document.getElementById('datos-actuales').classList.remove('hidden');

  /* Prellenar formulario de ediciÃ³n */
  document.getElementById('usuario-id').value = usuarioActual.id;
  document.getElementById('nombre').value = usuarioActual.nombre;
  document.getElementById('correo').value = usuarioActual.correo;
  document.getElementById('formulario-edicion').classList.remove('hidden');

  /* Cargar estadÃ­sticas */
  const resPujas = await fetch(`/api/usuario/${usuarioActual.id}/pujas`);
  const pujas = await resPujas.json();
  
  if (!pujas.error) {
    const subastas = new Set(pujas.map(p => p.subasta.id));
    
    document.getElementById('total-pujas').textContent = pujas.length;
    document.getElementById('total-subastas').textContent = subastas.size;
    document.getElementById('estadisticas').classList.remove('hidden');
  }
}

/* Actualizar perfil */
const form = document.getElementById('perfil-form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const body = {
    id: parseInt(document.getElementById('usuario-id').value),
    nombre: document.getElementById('nombre').value,
    correo: document.getElementById('correo').value
  };

  const res = await fetch('/api/usuario/actualizar', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });

  const result = await res.json();

  if (result.error) {
    alert('âŒ ' + result.error);
  } else {
    alert('âœ… Datos actualizados correctamente.');
    /* Recargar los datos */
    obtenerUsuarioActual();
  }
});

/* Cargar automÃ¡ticamente al inicio */
window.addEventListener('DOMContentLoaded', () => {
  obtenerUsuarioActual();
});
</script>

{% endblock %}